@model DSLNG.PEAR.Web.ViewModels.KpiAchievement.ConfigurationKpiAchievementsViewModel
@{
    ViewBag.Title = "Configuration";
}

<h2>Configuration</h2>

<section>
    <div class="row">
        <div class="title_page" style="border: none!important;">
            <div class="title" style="margin-right: 25px;">KPI Achievement</div>
            <img class="ajax-loader2" src="@Url.Content("~/content/img/ajax-loader1.gif")" style="display: none;width: 30px;height: 30px;"></img>
            <div class="description_year"></div>
        </div>
    </div>

    <ul class="nav nav-tabs">
        <li role="presentation" class="active">
            <a href="#yearly" aria-controls="home" role="tab" data-toggle="tab" data-periodetype="yearly">
                <div>Yearly</div>
            </a>
        </li>
        <li role="presentation">
            <a href="#monthly" aria-controls="home" role="tab" data-toggle="tab" data-periodetype="monthly">
                <div>Monthly</div>
            </a>
        </li>
        <li role="presentation">
            <a href="#daily" aria-controls="home" role="tab" data-toggle="tab" data-periodetype="daily">
                <div>Daily</div>
            </a>
        </li>
    </ul>

    <div class="tab-content">
        <div role="tabpanel" class="tab-pane active" id="yearly">
            @Html.Partial("Configuration/_Yearly", Model)
        </div>
        <div role="tabpanel" class="tab-pane" id="monthly">
            monthly
        </div>
        <div role="tabpanel" class="tab-pane" id="daily">
            daily
        </div>
    </div>
</section>
<div class="popover-content" style="display:none">
    <label class="control-label">Value</label>
    <input type="text" name="Value" class="form-control" />
    <label class="control-label">Remark</label>
    <input type="text" name="Remark" class="form-control" />
    <input type="hidden" name="Id" />
    <input type="hidden" name="KpiId" />
    <input type="hidden" name="Periode" />
    <input type="hidden" name="PeriodeType" />
    <button type="button" class="btn btn-primary submit-popover">Ok</button>
    <button type="button" class="btn btn-primary cancel-popover">Cancel</button>
</div>
@section Scripts
{
    <script type="text/javascript">
        $(document).ready(function () {
            $('[data-toggle=tab]').click(function () {
                var that = $(this);
                var periodeType = that.attr('data-periodeType');
                $.ajax({
                    url: '@Url.Action("ConfigurationPartial")',
                    type: 'GET',
                    data: { id: '@Model.RoleGroupId', periodeType: periodeType },
                    beforeSend: function () {
                        $('.ajax-loader2').show();
                        //$('.content-wrapper').hide();
                    }
                })
                .done(function (data) {
                    $('.ajax-loader2').hide();
                    $('.update-content').html(data);
                    $('.content-wrapper').show();
                });
                @*var val = $(this).val();
                $.ajax({
                    url: '@Url.Action("UpdatePartial")',
                    type: 'GET',
                    data: { id: '@Model.PmsSummaryId', periodeType: val },
                beforeSend: function () {
                    $('.ajax-loader2').show();
                    $('.content-wrapper').hide();
                }
                })
                .done(function (data) {
                    $('.ajax-loader2').hide();
                    $('.update-content').html(data);
                    $('.content-wrapper').show();
                });*@
            });

            $('body').popover({
                selector: '.kpi-popover',
                html: true,
                title: function () {
                    return $(this).parent().find('.header-popover').val();
                },
                content: function () {
                    return $('.popover-content').html();
                }
            });
        });
        var popOverElem;
        $(document).on('click', '.kpi-popover', function () {
            if (popOverElem !== undefined && $(this).attr('id') !== popOverElem.attr('id')) {
                popOverElem.popover('hide');
            }
            var value = $(this).parent().find('.value').val();
            var remark = $(this).parent().find('.remark').val();
            var id = $(this).parent().find('.id').val();
            var kpiId = $(this).parent().find('.kpiId').val();
            var periode = $(this).parent().find('.periode').val();
            var periodeType = $(this).parent().find('.periodeType').val();
            $('.popover').find('input[name="Value"]').attr('value', value);
            $('.popover').find('input[name="Remark"]').attr('value', remark);
            $('.popover').find('input[name="Id"]').attr('value', id);
            $('.popover').find('input[name="KpiId"]').attr('value', kpiId);
            $('.popover').find('input[name="Periode"]').attr('value', periode);
            $('.popover').find('input[name="PeriodeType"]').attr('value', periodeType);
            popOverElem = $(this);
        });

        $(document).on('click', '.submit-popover', function () {
            var value = $(this).parent().find('input[name="Value"]').val();
            var remark = $(this).parent().find('input[name="Remark"]').val();
            var kpiTarget = $('.popover').parent();
            $(kpiTarget).find('.value').attr('value', value);
            $(kpiTarget).find('.remark').attr('value', remark);
            var formData = {
                'id': $(this).parent().find('input[name=Id]').val(),
                'kpiId': $(this).parent().find('input[name=KpiId]').val(),
                'value': $(this).parent().find('input[name=Value]').val(),
                'remark': $(this).parent().find('input[name=Remark]').val(),
                'periode': $(this).parent().find('input[name=Periode]').val(),
                'periodeType': $(this).parent().find('input[name=PeriodeType]').val()
            };
            $.ajax({
                type: "POST",
                url: '@Url.Action("KpiAchievementItem")',
                data: formData,
                success: function (data) {
                    $(this).closest('td').find('.id').attr('value', data.Id);
                    if (remark.length > 0) {
                        $('.popover').parent().find('.value').addClass('remark_sign');
                    }
                    alert(data.Message);
                    $('.popover').popover('hide');
                },
            });
        });

        $(document).on('click', '.cancel-popover', function () {
            $('.popover').popover('hide');
        });
    </script>
}
